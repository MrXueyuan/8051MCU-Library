C51 COMPILER V9.57.0.0   MAIN                                                              04/30/2018 16:54:58 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: E:\STCMCU\Keil-v5\C51\BIN\C51.EXE main.c LARGE OBJECTADVANCED OPTIMIZE(9,SPEED) REGFILE(.\Objects\u
                    -rat.ORC) BROWSE DEBUG PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          
   2          //***************************************
   3          // GY-52 MPU3050 IICæµ‹è¯•ç¨‹åº
   4          // ä½¿ç”¨å•ç‰‡æœºSTC89C51 
   5          // æ™¶æŒ¯ï¼š11.0592M
   6          // æ˜¾ç¤ºï¼šLCD1602
   7          // ç¼–è¯‘ç¯å¢ƒ Keil uVision2
   8          // å‚è€ƒå®æ™¶ç½‘ç«™24c04é€šä¿¡ç¨‹åº
   9          // æ—¶é—´ï¼š2011å¹´9æœˆ1æ—¥
  10          // QQï¼š531389319
  11          //****************************************
  12          #include  <REG52.H> 
  13          #include  <math.h>    //Keil library  
  14          #include  <stdio.h>   //Keil library  
  15          #include  <INTRINS.H>
  16          #define   uchar unsigned char
  17          #define   uint unsigned int 
  18          #define   DataPort P0    //LCD1602æ•°æ®ç«¯å£
  19          sbit    SCL=P1^0;      //IICæ—¶é’Ÿå¼•è„šå®šä¹‰
  20          sbit    SDA=P1^1;      //IICæ•°æ®å¼•è„šå®šä¹‰
  21          sbit      LCM_RS=P2^0;   //LCD1602å‘½ä»¤ç«¯å£    
  22          sbit      LCM_RW=P2^1;   //LCD1602å‘½ä»¤ç«¯å£    
  23          sbit      LCM_EN=P2^2;   //LCD1602å‘½ä»¤ç«¯å£ 
  24          #define FOSC    11059200L
  25          #define BAUD  9600
  26          sfr AUXR  =0x8E;
  27          //å®šä¹‰MPU3050å†…éƒ¨åœ°å€********************
  28          #define WHO     0x00
  29          #define SMPL  0x15
  30          #define DLPF  0x16
  31          #define INT_C 0x17
  32          #define INT_S 0x1A
  33          #define TMP_H 0x1B
  34          #define TMP_L 0x1C
  35          #define GX_H  0x1D
  36          #define GX_L  0x1E
  37          #define GY_H  0x1F
  38          #define GY_L  0x20
  39          #define GZ_H  0x21
  40          #define GZ_L  0x22
  41          #define PWR_M 0x3E
  42          //****************************
  43          
  44          #define SlaveAddress   0xD0   //å®šä¹‰å™¨ä»¶åœ¨IICæ€»çº¿ä¸­çš„ä»åœ°å€,æ ¹æ®ALT  ADDRESSåœ°å€å¼•è„šä¸å
             -Œä¿®æ”¹
  45                                    
  46          typedef unsigned char  BYTE;
  47          typedef unsigned short WORD;
  48          int *output;
  49          uchar dis[4];                         //æ˜¾ç¤ºæ•°ç»„
  50          BYTE BUF[8];                         //æ¥æ”¶æ•°æ®ç¼“å­˜åŒº        
  51          bit busy=0;
  52          int  dis_data;                       //å˜é‡
  53          int Temperature,Temp_h,Temp_l;
C51 COMPILER V9.57.0.0   MAIN                                                              04/30/2018 16:54:58 PAGE 2   

  54          void delay(unsigned int k);
  55          void InitLcd();                     //åˆå§‹åŒ–lcd1602
  56          void InitMPU3050();                 //åˆå§‹åŒ–MPU3050
  57          
  58          void WriteDataLCM(uchar dataW);
  59          void WriteCommandLCM(uchar CMD,uchar Attribc);
  60          void DisplayOneChar(uchar X,uchar Y,uchar DData);
  61          void DisplayListChar(uchar X,uchar Y,uchar *DData,L);
  62          
  63          void  Single_WriteMPU3050(uchar REG_Address,uchar REG_data);   //å•ä¸ªå†™å…¥æ•°æ®
  64          uchar Single_ReadMPU3050(uchar REG_Address);                   //å•ä¸ªè¯»å–å†…éƒ¨å¯„å­˜å™¨æ•°æ®
  65          
  66          //****************************************æ¨¡æ‹ŸIICä½¿ç”¨å‡½æ•°
  67          void Delay5us();
  68          void MPU3050_Start();
  69          void MPU3050_Stop();
  70          void MPU3050_SendACK(bit ack);
  71          bit  MPU3050_RecvACK();
  72          void MPU3050_SendByte(BYTE dat);
  73          BYTE MPU3050_RecvByte();
  74          void MPU3050_ReadPage();
  75          void MPU3050_WritePage();
  76          //****************************************
  77          void display_x();
  78          void display_y();
  79          void display_z();
  80          
  81          //****************************************
  82          
  83          void lcd_printf(uchar *s,int temp_data)
  84          {
  85   1        if(temp_data<0){
  86   2        temp_data=-temp_data;
  87   2          *s='-';
  88   2        }
  89   1        else *s=' ';
  90   1          *++s =temp_data/100+0x30;
  91   1          temp_data=temp_data%100;     //å–ä½™è¿ç®—
  92   1          *++s =temp_data/10+0x30;
  93   1          temp_data=temp_data%10;      //å–ä½™è¿ç®—
  94   1          *++s =temp_data+0x30;   
  95   1      }
  96          
  97          /*******************************/
  98          void delay(unsigned int k)  
  99          {           
 100   1      unsigned int i,j;       
 101   1      for(i=0;i<k;i++)
 102   1      {     
 103   2      for(j=0;j<121;j++)      
 104   2      {;}}            
 105   1      }
 106          /*******************************/
 107          void WaitForEnable(void)  
 108          {         
 109   1      DataPort=0xff;    
 110   1      LCM_RS=0;LCM_RW=1;_nop_();
 111   1      LCM_EN=1;_nop_();_nop_();
 112   1      while(DataPort&0x80); 
 113   1      LCM_EN=0;       
 114   1      }         
 115          /*******************************/
C51 COMPILER V9.57.0.0   MAIN                                                              04/30/2018 16:54:58 PAGE 3   

 116          void WriteCommandLCM(uchar CMD,uchar Attribc)
 117          {         
 118   1      if(Attribc)WaitForEnable(); 
 119   1      LCM_RS=0;LCM_RW=0;_nop_();
 120   1      DataPort=CMD;_nop_(); 
 121   1      LCM_EN=1;_nop_();_nop_();LCM_EN=0;
 122   1      }         
 123          /*******************************/
 124          void WriteDataLCM(uchar dataW)
 125          {         
 126   1      WaitForEnable();    
 127   1      LCM_RS=1;LCM_RW=0;_nop_();
 128   1      DataPort=dataW;_nop_(); 
 129   1      LCM_EN=1;_nop_();_nop_();LCM_EN=0;
 130   1      }   
 131          /***********************************/
 132          void InitLcd()        
 133          {     
 134   1      WriteCommandLCM(0x38,1);  
 135   1      WriteCommandLCM(0x08,1);  
 136   1      WriteCommandLCM(0x01,1);  
 137   1      WriteCommandLCM(0x06,1);  
 138   1      WriteCommandLCM(0x0c,1);
 139   1      DisplayOneChar(0,0,'x');
 140   1      DisplayOneChar(1,0,':');
 141   1      DisplayOneChar(0,1,'y');
 142   1      DisplayOneChar(1,1,':');
 143   1      DisplayOneChar(9,0,'z');
 144   1      DisplayOneChar(10,0,':');
 145   1      DisplayOneChar(9,1,'T');
 146   1      DisplayOneChar(10,1,':');
 147   1      }     
 148          /***********************************/
 149          void DisplayOneChar(uchar X,uchar Y,uchar DData)
 150          {           
 151   1      Y&=1;           
 152   1      X&=15;            
 153   1      if(Y)X|=0x40;         
 154   1      X|=0x80;      
 155   1      WriteCommandLCM(X,0);   
 156   1      WriteDataLCM(DData);    
 157   1      }           
 158          /***********************************/
 159          void DisplayListChar(uchar X,uchar Y,uchar *DData,L)
 160          {
 161   1      uchar ListLength=0; 
 162   1      Y&=0x1;                
 163   1      X&=0xF;                
 164   1      while(L--)             
 165   1      {                       
 166   2      DisplayOneChar(X,Y,DData[ListLength]);
 167   2      ListLength++;  
 168   2      X++;                        
 169   2      }    
 170   1      }
 171          /**************************************
 172          å»¶æ—¶5å¾®ç§’(STC90C52RC@12M)
 173          ä¸åŒçš„å·¥ä½œç¯å¢ƒ,éœ€è¦è°ƒæ•´æ­¤å‡½æ•°ï¼Œæ³¨æ„æ—¶é’Ÿè¿‡å¿«æ—¶éœ€è¦ä¿®æ”¹
 174          å½“æ”¹ç”¨1Tçš„MCUæ—¶,è¯·è°ƒæ•´æ­¤å»¶æ—¶å‡½æ•°
 175          **************************************/
 176          void Delay5us()   //@11.0592MHz
 177          {
C51 COMPILER V9.57.0.0   MAIN                                                              04/30/2018 16:54:58 PAGE 4   

 178   1        unsigned char i;
 179   1      
 180   1        _nop_();
 181   1        i = 11;
 182   1        while (--i);
 183   1      }
 184          
 185          
 186            
 187          void SendData(unsigned char dat)
 188          {
 189   1        while(busy);
 190   1        SBUF=dat;
 191   1        busy=1;
 192   1      }
 193          void SendString(int *s)
 194          {
 195   1        while(*s!='\0')
 196   1          SendData(*s++);
 197   1      }
 198          
 199          
 200          /**************************************
 201          èµ·å§‹ä¿¡å·
 202          **************************************/
 203          void MPU3050_Start()
 204          {
 205   1          SDA = 1;                    //æ‹‰é«˜æ•°æ®çº¿
 206   1          SCL = 1;                    //æ‹‰é«˜æ—¶é’Ÿçº¿
 207   1          Delay5us();                 //å»¶æ—¶
 208   1          SDA = 0;                    //äº§ç”Ÿä¸‹é™æ²¿
 209   1          Delay5us();                 //å»¶æ—¶
 210   1          SCL = 0;                    //æ‹‰ä½æ—¶é’Ÿçº¿
 211   1      }
 212          
 213          /**************************************
 214          åœæ­¢ä¿¡å·
 215          **************************************/
 216          void MPU3050_Stop()
 217          {
 218   1          SDA = 0;                    //æ‹‰ä½æ•°æ®çº¿
 219   1          SCL = 1;                    //æ‹‰é«˜æ—¶é’Ÿçº¿
 220   1          Delay5us();                 //å»¶æ—¶
 221   1          SDA = 1;                    //äº§ç”Ÿä¸Šå‡æ²¿
 222   1          Delay5us();                 //å»¶æ—¶
 223   1      }
 224          
 225          /**************************************
 226          å‘é€åº”ç­”ä¿¡å·
 227          å…¥å£å‚æ•°:ack (0:ACK 1:NAK)
 228          **************************************/
 229          void MPU3050_SendACK(bit ack)
 230          {
 231   1          SDA = ack;                  //å†™åº”ç­”ä¿¡å·
 232   1          SCL = 1;                    //æ‹‰é«˜æ—¶é’Ÿçº¿
 233   1          Delay5us();                 //å»¶æ—¶
 234   1          SCL = 0;                    //æ‹‰ä½æ—¶é’Ÿçº¿
 235   1          Delay5us();                 //å»¶æ—¶
 236   1      }
 237          
 238          /**************************************
 239          æ¥æ”¶åº”ç­”ä¿¡å·
C51 COMPILER V9.57.0.0   MAIN                                                              04/30/2018 16:54:58 PAGE 5   

 240          **************************************/
 241          bit MPU3050_RecvACK()
 242          {
 243   1          SCL = 1;                    //æ‹‰é«˜æ—¶é’Ÿçº¿
 244   1          Delay5us();                 //å»¶æ—¶
 245   1          CY = SDA;                   //è¯»åº”ç­”ä¿¡å·
 246   1          SCL = 0;                    //æ‹‰ä½æ—¶é’Ÿçº¿
 247   1          Delay5us();                 //å»¶æ—¶
 248   1      
 249   1          return CY;
 250   1      }
 251          
 252          /**************************************
 253          å‘IICæ€»çº¿å‘é€ä¸€ä¸ªå­—èŠ‚æ•°æ®
 254          **************************************/
 255          void MPU3050_SendByte(BYTE dat)
 256          {
 257   1          BYTE i;
 258   1      
 259   1          for (i=0; i<8; i++)         //8ä½è®¡æ•°å™¨
 260   1          {
 261   2              dat <<= 1;              //ç§»å‡ºæ•°æ®çš„æœ€é«˜ä½
 262   2              SDA = CY;               //é€æ•°æ®å£
 263   2              SCL = 1;                //æ‹‰é«˜æ—¶é’Ÿçº¿
 264   2              Delay5us();             //å»¶æ—¶
 265   2              SCL = 0;                //æ‹‰ä½æ—¶é’Ÿçº¿
 266   2              Delay5us();             //å»¶æ—¶
 267   2          }
 268   1          MPU3050_RecvACK();
 269   1      }
 270          
 271          /**************************************
 272          ä»IICæ€»çº¿æ¥æ”¶ä¸€ä¸ªå­—èŠ‚æ•°æ®
 273          **************************************/
 274          BYTE MPU3050_RecvByte()
 275          {
 276   1          BYTE i;
 277   1          BYTE dat = 0;
 278   1      
 279   1          SDA = 1;                    //ä½¿èƒ½å†…éƒ¨ä¸Šæ‹‰,å‡†å¤‡è¯»å–æ•°æ®,
 280   1          for (i=0; i<8; i++)         //8ä½è®¡æ•°å™¨
 281   1          {
 282   2              dat <<= 1;
 283   2              SCL = 1;                //æ‹‰é«˜æ—¶é’Ÿçº¿
 284   2              Delay5us();             //å»¶æ—¶
 285   2              dat |= SDA;             //è¯»æ•°æ®               
 286   2              SCL = 0;                //æ‹‰ä½æ—¶é’Ÿçº¿
 287   2              Delay5us();             //å»¶æ—¶
 288   2          }
 289   1          return dat;
 290   1      }
 291          
 292          //å•å­—èŠ‚å†™å…¥*******************************************
 293          
 294          void Single_WriteMPU3050(uchar REG_Address,uchar REG_data)
 295          {
 296   1          MPU3050_Start();                  //èµ·å§‹ä¿¡å·
 297   1          MPU3050_SendByte(SlaveAddress);   //å‘é€è®¾å¤‡åœ°å€+å†™ä¿¡å·
 298   1          MPU3050_SendByte(REG_Address);    //å†…éƒ¨å¯„å­˜å™¨åœ°å€ï¼Œ
 299   1          MPU3050_SendByte(REG_data);       //å†…éƒ¨å¯„å­˜å™¨æ•°æ®ï¼Œ
 300   1          MPU3050_Stop();                   //å‘é€åœæ­¢ä¿¡å·
 301   1      }
C51 COMPILER V9.57.0.0   MAIN                                                              04/30/2018 16:54:58 PAGE 6   

 302          
 303          //å•å­—èŠ‚è¯»å–*****************************************
 304          uchar Single_ReadMPU3050(uchar REG_Address)
 305          {  uchar REG_data;
 306   1          MPU3050_Start();                          //èµ·å§‹ä¿¡å·
 307   1          MPU3050_SendByte(SlaveAddress);           //å‘é€è®¾å¤‡åœ°å€+å†™ä¿¡å·
 308   1          MPU3050_SendByte(REG_Address);            //å‘é€å­˜å‚¨å•å…ƒåœ°å€ï¼Œä»0å¼€å§‹ 
 309   1          MPU3050_Start();                          //èµ·å§‹ä¿¡å·
 310   1          MPU3050_SendByte(SlaveAddress+1);         //å‘é€è®¾å¤‡åœ°å€+è¯»ä¿¡å·
 311   1          REG_data=MPU3050_RecvByte();              //è¯»å‡ºå¯„å­˜å™¨æ•°æ®
 312   1        MPU3050_SendACK(1);   
 313   1        MPU3050_Stop();                           //åœæ­¢ä¿¡å·
 314   1          return REG_data; 
 315   1      }
 316          
 317          //åˆå§‹åŒ–MPU3050ï¼Œæ ¹æ®éœ€è¦è¯·å‚è€ƒpdfè¿›è¡Œä¿®æ”¹************************
 318          void InitMPU3050()
 319          {
 320   1         Single_WriteMPU3050(PWR_M, 0x80);   //
 321   1         Single_WriteMPU3050(SMPL, 0x07);    //
 322   1         Single_WriteMPU3050(DLPF, 0x1E);    //Â±2000Â°
 323   1         Single_WriteMPU3050(INT_C, 0x00 );  //
 324   1         Single_WriteMPU3050(PWR_M, 0x00);   //
 325   1      }
 326          //***********************************************************************
 327          //æ˜¾ç¤ºxè½´
 328          void display_x()
 329          {  
 330   1          BUF[0]= Single_ReadMPU3050(GX_L);
 331   1          BUF[1]= Single_ReadMPU3050(GX_H);
 332   1          dis_data=(BUF[1]<<8)+BUF[0];   //åˆæˆæ•°æ®   
 333   1          dis_data/=16.4;              //è®¡ç®—å¯¹åº” åº¦/ç§’
 334   1          output = &dis_data;
 335   1          SendString(&output);
*** WARNING C182 IN LINE 335 OF main.c: pointer to different objects
 336   1          //lcd_printf(dis, dis_data);     //è½¬æ¢æ•°æ®æ˜¾ç¤º  
 337   1          //DisplayListChar(2,0,dis,4);    //å¯å§‹åˆ—ï¼Œè¡Œï¼Œæ˜¾ç¤ºæ•°ç»„ï¼Œæ˜¾ç¤ºé•¿åº¦
 338   1      }
 339          
 340          //***********************************************************************
 341          //æ˜¾ç¤ºyè½´
 342          void display_y()
 343          {    
 344   1          BUF[2]= Single_ReadMPU3050(GY_L);
 345   1          BUF[3]= Single_ReadMPU3050(GY_H);
 346   1          dis_data=(BUF[3]<<8)+BUF[2];   //åˆæˆæ•°æ®   
 347   1          dis_data/=16.4;              //è®¡ç®—å¯¹åº” åº¦/ç§’
 348   1          output = &dis_data;
 349   1          SendString(&output);
*** WARNING C182 IN LINE 349 OF main.c: pointer to different objects
 350   1          //lcd_printf(dis, dis_data);     //è½¬æ¢æ•°æ®æ˜¾ç¤º
 351   1          //DisplayListChar(2,1,dis,4);    //å¯å§‹åˆ—ï¼Œè¡Œï¼Œæ˜¾ç¤ºæ•°ç»„ï¼Œæ˜¾ç¤ºä½æ•°
 352   1      }
 353          
 354          //***********************************************************************
 355          //æ˜¾ç¤ºzè½´
 356          void display_z()
 357          { 
 358   1          BUF[4]= Single_ReadMPU3050(GZ_L);
 359   1          BUF[5]= Single_ReadMPU3050(GZ_H);
 360   1          dis_data=(BUF[5]<<8)+BUF[4];     //åˆæˆæ•°æ®   
 361   1          dis_data/=16.4;                //è®¡ç®—å¯¹åº” åº¦/ç§’
C51 COMPILER V9.57.0.0   MAIN                                                              04/30/2018 16:54:58 PAGE 7   

 362   1          output = &dis_data;
 363   1          SendString(&output);
*** WARNING C182 IN LINE 363 OF main.c: pointer to different objects
 364   1          //lcd_printf(dis, dis_data);       //è½¬æ¢æ•°æ®æ˜¾ç¤º
 365   1          //DisplayListChar(11,0,dis,4);     //å¯å§‹åˆ—ï¼Œè¡Œï¼Œæ˜¾ç¤ºæ•°ç»„ï¼Œæ˜¾ç¤ºä½æ•°
 366   1      }
 367          
 368          
 369          void uart1() interrupt 4
 370          {
 371   1        if(RI)
 372   1          RI=0;
 373   1        if(TI)
 374   1          TI=0;
 375   1          busy=0;
 376   1      }
 377          
 378          //*********************************************************
 379          //******ä¸»ç¨‹åº********
 380          //*********************************************************
 381          void main()
 382          { 
 383   1        delay(500);                    //ä¸Šç”µå»¶æ—¶
 384   1        
 385   1        SCON=0x50;
 386   1        AUXR=0x14;
 387   1        AUXR|=0x01;
 388   1        TL2=(65536-((FOSC/4)/BAUD));
 389   1        TH2=(65536-((FOSC/4)/BAUD))>>8;
 390   1        ES=1;
 391   1        EA=1;   
 392   1        //InitLcd();                       //æ¶²æ™¶åˆå§‹åŒ–
 393   1        InitMPU3050();                   //åˆå§‹åŒ–MPU3050
 394   1        delay(50);
 395   1        while(1)                         //å¾ªç¯
 396   1        {   
 397   2          display_x();                   //---------æ˜¾ç¤ºXè½´
 398   2          display_y();                   //---------æ˜¾ç¤ºYè½´
 399   2          display_z();                   //---------æ˜¾ç¤ºZè½´
 400   2          delay(10000);                    //å»¶æ—¶            
 401   2        }
 402   1      } 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1206    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     23      16
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1       1
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  3 WARNING(S),  0 ERROR(S)
